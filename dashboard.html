<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skinship Beauty Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --glow-color: 132, 0, 255;
      --border-color: #f7d4d0;
      --background-dark: #ffffff;
    }
    
    body, html {
      height: 100%;
      width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }
    
    aside {
      position: fixed;
      left: 0;
      top: 0;
      width: 80px;
      height: 100vh;
      z-index: 1000;
      background-color: #f7d4d0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
      gap: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0 1.5rem 1.5rem 0;
      overflow-y: auto;
    }
    
    .sidebar-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: #da5c73;
      font-size: 20px;
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: .3s;
      flex-shrink: 0;
      position: relative;
    }

    .sidebar-btn:hover {
      background: #da5c73;
      color: white;
      transform: scale(1.1);
    }

    .sidebar-btn.active {
      background: #da5c73;
      color: white;
    }

    html.staff-loaded .sidebar-btn {
      display: none !important;
    }

    html.staff-loaded .sidebar-btn[title="Dashboard"],
    html.staff-loaded .sidebar-btn[title="Reports"],
    html.staff-loaded .sidebar-btn[title="Cashier"],
    html.staff-loaded .sidebar-btn[title="Staff"] {
      display: flex !important;
    }

    .sidebar-bubble {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #dc2626;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      z-index: 10;
      border: 2px solid #f7d4d0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    html.admin-loaded .sidebar-btn {
      display: flex !important;
    }
    
    html.staff-loaded .sidebar-btn {
      display: none !important;
    }

    .role-restricted {
      display: none !important;
    }
    
    html.admin-loaded .role-restricted {
      display: flex !important;
    }
    
    html.admin-loaded a.role-restricted {
      display: inline-block !important;
    }

    html.admin-loaded button.role-restricted {
      display: flex !important;
    }
    
    main {
      margin-left: 80px;
      width: calc(100% - 80px);
      min-height: 100vh;
      padding: 1.5rem;
      overflow-x: hidden;
    }
    
    .dashboard-container {
      background-color: #b97b8b;
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 100%;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-width: 100%;
      width: 100%;
    }
    
    .table-wrapper table {
      width: 100%;
      min-width: 100%;
      table-layout: auto;
    }
    
    .table-wrapper td, 
    .table-wrapper th {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 8px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
      width: 100%;
      position: relative;
      user-select: none;
    }

    .magic-card {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      color: #1f2937;
      border: 1px solid var(--border-color);
      background: var(--background-dark);
      border-radius: 1.25rem;
      padding: 1rem;
      --glow-x: 50%;
      --glow-y: 50%;
      --glow-intensity: 0;
      --glow-radius: 300px;
    }

    .magic-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .magic-card * {
      color: inherit;
    }

    .magic-card h2,
    .magic-card .font-bold,
    .magic-card th {
      color: #1f2937;
    }

          .inventory-carousel-wrapper {
  position: relative;
  height: 140px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.inventory-alert-item {
  position: absolute;
  width: 100%;
  opacity: 0;
  transition: opacity 0.5s ease;
  padding: 1rem;
  border-radius: 0.75rem;
  cursor: pointer;
}

.inventory-alert-item.active {
  opacity: 1;
  position: relative;
}

.inventory-alert-item:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px);
  transition: all 0.3s ease;
}

.alert-out-of-stock {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  border: 2px solid #fca5a5;
}

.alert-low-stock {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #fcd34d;
}

.alert-overstock {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  border: 2px solid #93c5fd;
}

.progress-bar-container {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 9999px;
  height: 8px;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-bar {
  height: 100%;
  border-radius: 9999px;
  transition: width 0.5s ease;
}

.nav-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #d1d5db;
  cursor: pointer;
  transition: all 0.3s ease;
}

.nav-dot.active {
  background: #da5c73;
  width: 24px;
  border-radius: 5px;
}

.nav-dot:hover {
  background: #b97b8b;
  transform: scale(1.2);
}

    .magic-card p,
    .magic-card td,
    .magic-card span,
    .magic-card div {
      color: #1f2937;
    }

    .magic-card a {
      color: #da5c73;
    }

    .magic-card::after {
      content: '';
      position: absolute;
      inset: 0;
      padding: 2px;
      background: radial-gradient(
        var(--glow-radius) circle at var(--glow-x) var(--glow-y),
        rgba(var(--glow-color), calc(var(--glow-intensity) * 0.7)) 0%,
        rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)) 30%,
        rgba(var(--glow-color), calc(var(--glow-intensity) * 0.2)) 50%,
        transparent 70%
      );
      border-radius: inherit;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: subtract;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1;
      opacity: 0;
    }

    .magic-card:hover::after {
      opacity: 1;
    }

    .magic-card:hover {
      box-shadow: 0 8px 25px rgba(132, 0, 255, 0.25), 0 0 30px rgba(132, 0, 255, 0.15);
    }

    .particle {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: rgba(var(--glow-color), 1);
      box-shadow: 0 0 8px rgba(var(--glow-color), 0.6), 0 0 16px rgba(var(--glow-color), 0.3);
      pointer-events: none;
      z-index: 100;
    }

    .particle::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: rgba(var(--glow-color), 0.25);
      border-radius: 50%;
      z-index: -1;
    }

    .global-spotlight {
      position: fixed;
      width: 1200px;
      height: 1200px;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle,
        rgba(var(--glow-color), 0.35) 0%,
        rgba(var(--glow-color), 0.25) 15%,
        rgba(var(--glow-color), 0.15) 25%,
        rgba(var(--glow-color), 0.08) 40%,
        rgba(var(--glow-color), 0.04) 65%,
        transparent 70%
      );
      z-index: 200;
      opacity: 0;
      transform: translate(-50%, -50%);
      mix-blend-mode: screen;
      will-change: transform, opacity;
      filter: blur(3px);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .logout-modal {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .logout-modal {
      transform: scale(1);
    }

    .logout-modal-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .logout-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #fecaca 0%, #ef4444 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .logout-icon i {
      font-size: 2.5rem;
      color: white;
    }

    .logout-modal-header h2 {
      color: #1f2937;
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .logout-modal-header p {
      color: #6b7280;
      font-size: 1rem;
    }

    .logout-modal-body {
      background: #f9fafb;
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .logout-info-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: white;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .logout-info-item:last-child {
      margin-bottom: 0;
    }

    .logout-info-item i {
      color: #8b5cf6;
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
    }

    .logout-info-item span {
      color: #1f2937;
      font-size: 0.95rem;
    }

    .logout-modal-actions {
      display: flex;
      gap: 1rem;
    }

    .logout-btn {
      flex: 1;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .logout-btn-cancel {
      background: #e5e7eb;
      color: #1f2937;
    }

    .logout-btn-cancel:hover {
      background: #d1d5db;
    }

    .logout-btn-confirm {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }

    .logout-btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4);
    }

    .logout-btn-confirm.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .logout-btn-confirm.loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .staff-availability-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #f3f4f6;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .staff-availability-item:last-child {
      margin-bottom: 0;
    }

    .status-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #10b981;
      flex-shrink: 0;
    }

    html.staff-loaded .inventory-alert-item {
      cursor: default !important;
      pointer-events: none !important;
    }

    html.admin-loaded .inventory-alert-item {
      cursor: pointer !important;
      pointer-events: auto !important;
    }
    
    @media (max-width: 768px) {
      .dashboard-grid > div {
        grid-column: span 12 !important;
      }
      
      main {
        margin-left: 0;
        width: 100%;
      }
      
      aside {
        width: 100%;
        height: auto;
        flex-direction: row;
        position: relative;
        border-radius: 0;
      }

      .logout-modal {
        padding: 1.5rem;
      }

      .logout-modal-actions {
        flex-direction: column-reverse;
      }

      .logout-btn {
        width: 100%;
      }

      /* Toast Notification Styles */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.toast {
  background: white;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 300px;
  max-width: 500px;
  pointer-events: all;
  animation: slideIn 0.3s ease-out;
  border-left: 4px solid #3b82f6;
}

.toast.success {
  border-left-color: #10b981;
}

.toast.error {
  border-left-color: #ef4444;
}

.toast.warning {
  border-left-color: #f59e0b;
}

.toast.info {
  border-left-color: #3b82f6;
}

.toast-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.toast.success .toast-icon {
  color: #10b981;
}

.toast.error .toast-icon {
  color: #ef4444;
}

.toast.warning .toast-icon {
  color: #f59e0b;
}

.toast.info .toast-icon {
  color: #3b82f6;
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  color: #1f2937;
  font-size: 14px;
  margin-bottom: 2px;
}

.toast-message {
  color: #6b7280;
  font-size: 13px;
  line-height: 1.4;
}

.toast-close {
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.toast-close:hover {
  background: #f3f4f6;
  color: #1f2937;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.toast.hiding {
  animation: slideOut 0.3s ease-in forwards;
}

      .sidebar-bubble {
        width: 18px;
        height: 18px;
        font-size: 9px;
        top: -3px;
        right: -3px;
      }
    }
  </style>
</head>
<body class="bg-[#e6bfc7]">
  <!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
  <aside id="sidebar">
    <div class="mb-6 mt-2">
      <i class="fa-solid fa-spa text-3xl text-[#da5c73]"></i>
    </div>
    <button class="sidebar-btn active" title="Dashboard" onclick="window.location.href='dashboard.html'"><i class="fa-solid fa-table-columns"></i></button>
    <button class="sidebar-btn role-restricted" title="Reservations" onclick="window.location.href='calendar.html'"><i class="fa-solid fa-calendar-check"></i></button>
    <button class="sidebar-btn role-restricted" title="Customers" onclick="window.location.href='customer.html'"><i class="fa-solid fa-users"></i></button>
    <button class="sidebar-btn" title="Staff" onclick="window.location.href='staff.html'"><i class="fa-solid fa-user-tie"></i></button>
    <button class="sidebar-btn role-restricted" title="Services" onclick="window.location.href='services.html'"><i class="fa-solid fa-scissors"></i></button>
    <button class="sidebar-btn" title="Reports" onclick="window.location.href='sales.html'"><i class="fa-solid fa-chart-line"></i></button>
    <button class="sidebar-btn role-restricted" title="Inventory" onclick="window.location.href='inventory.html'"><i class="fa-solid fa-box-open"></i></button>
    <button class="sidebar-btn role-restricted" id="registrationBtn" title="Registration" onclick="window.location.href='Registration.html'"><i class="fa-solid fa-user-plus"></i></button>
    <button class="sidebar-btn" title="Cashier" onclick="window.location.href='Cashier.html'"><i class="fa-solid fa-cash-register"></i></button>
    <button class="sidebar-btn role-restricted" title="Invoice" onclick="window.location.href='invoice.html'"><i class="fa-solid fa-file-invoice"></i></button>
    <button class="sidebar-btn role-restricted" title="Purchase Order" onclick="window.location.href='purchase-order.html'"><i class="fa-solid fa-receipt"></i></button>
  </aside>

  <main>
<div class="dashboard-container">
  <div class="flex justify-end items-center gap-4 mb-6">
    <span class="font-semibold text-lg text-white" id="usernameDisplay">Loading...</span>
    <div class="relative">
      <button id="userMenuButton" onclick="toggleUserMenu(event)"><i class="fa-solid fa-user-circle text-2xl text-white"></i></button>
      <div id="userMenu" class="hidden absolute right-0 mt-2 w-36 bg-white rounded shadow-lg z-[9999]">
        <button id="logoutBtn" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
        </button>
      </div>      
    </div>
  </div>

  <!-- START OF DASHBOARD GRID -->
  <div class="dashboard-grid bento-section" id="dashboardGrid">
    
    <div style="grid-column: span 3;" class="magic-card shadow">
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 0.5rem;">
        <p id="completedCount" class="text-green-600 font-bold text-4xl m-0">0</p>
        <div class="font-bold text-center">Completed</div>
      </div>
    </div>

    <div style="grid-column: span 3;" class="magic-card shadow">
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 0.5rem;">
        <p id="pendingCount" class="text-yellow-600 font-bold text-4xl m-0">00</p>
        <div class="font-bold text-center">Pending</div>
      </div>
    </div>

    <div style="grid-column: span 3;" class="magic-card shadow">
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 0.5rem;">
        <p id="cancelledCount" class="text-red-600 font-bold text-4xl m-0">00</p>
        <div class="font-bold text-center">Cancelled</div>
      </div>
    </div>
    
    <div style="grid-column: span 3;" class="magic-card shadow">
      <h2 class="font-bold mb-3">Inventory Alerts</h2>
      <div class="inventory-carousel-wrapper" id="inventoryAlerts">
        <p class="text-gray-500 italic">Loading alerts...</p>
      </div>
      <div id="inventoryNav" class="flex justify-center gap-2 mt-3"></div>
    </div>

    <!-- Rest of your cards... -->

        <div style="grid-column: span 9;" class="magic-card shadow">
          <div class="flex justify-between items-center mb-5">
            <h2 class="font-bold">Reservation</h2>
            <a href="customer.html" id="viewAllReservations" class="text-sm text-rose-500 role-restricted hover:underline">View all</a>
          </div>
          <div class="table-wrapper">
            <table class="w-full text-sm">
              <thead class="text-left font-semibold">
                <tr>
                  <th>Customer</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Service</th>
                  <th>Staff</th>
                </tr>
              </thead>
              <tbody id="reservationTable">
                <tr>
                  <td colspan="5" class="text-center text-gray-500 italic">Loading reservations...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div style="grid-column: span 3;" class="magic-card shadow">
          <h2 class="font-bold mb-2">Staff Availability</h2>
          <div id="staffAvailabilityList">
            <p class="text-gray-500 italic text-sm">Loading...</p>
          </div>
        </div>

        <div style="grid-column: span 3;" class="magic-card shadow">
          <h2 class="font-bold mb-3">Top 3 Services Sold</h2>
          <div style="height: 180px; position: relative;">
            <canvas id="topServicesChart"></canvas>
          </div>
        </div>

        <div style="grid-column: span 6;" class="magic-card shadow">
          <h2 class="font-bold mb-3">Revenue (by Weekday)</h2>
          <canvas id="revenueChart" style="max-height: 200px;"></canvas>
          <p id="revenueTotal" class="text-right font-bold text-rose-600">Total of: ₱0.00</p>
        </div>

        <div style="grid-column: span 3;" class="magic-card shadow">
          <div class="flex justify-between items-center mb-2">
            <h2 class="font-bold">Today's Agenda</h2>
            <a href="calendar.html" id="viewAllAgenda" class="text-sm text-rose-500 role-restricted hover:underline">View all</a>
          </div>
          <ul id="agendaList" class="list-disc list-inside text-sm">
            <li class="text-gray-500 italic">Loading...</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="logoutModal">
    <div class="logout-modal">
      <div class="logout-modal-header">
        <div class="logout-icon">
          <i class="fa-solid fa-right-from-bracket"></i>
        </div>
        <h2>Confirm Logout</h2>
        <p>Are you sure you want to sign out?</p>
      </div>

      <div class="logout-modal-body">
        <div class="logout-info-item">
          <i class="fa-solid fa-user"></i>
          <span id="logoutUsername">Loading...</span>
        </div>
        <div class="logout-info-item">
          <i class="fa-solid fa-clock"></i>
          <span>Your session will be ended</span>
        </div>
        <div class="logout-info-item">
          <i class="fa-solid fa-shield-halved"></i>
          <span>You will be clocked out automatically</span>
        </div>
      </div>

      <div class="logout-modal-actions">
        <button class="logout-btn logout-btn-cancel" onclick="hideLogoutModal()">
          <i class="fa-solid fa-xmark"></i>
          Cancel
        </button>
        <button class="logout-btn logout-btn-confirm" id="confirmLogoutBtn" onclick="confirmLogout()">
          <i class="fa-solid fa-right-from-bracket"></i>
          Logout
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      onSnapshot,
      orderBy,
      getDocs,
      addDoc,
      updateDoc,
      serverTimestamp,
      setDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Yh7L4Wl9XRlOgxnzZyo8xxds6a02UJY",
      authDomain: "skinship-1ff4b.firebaseapp.com",
      projectId: "skinship-1ff4b",
      storageBucket: "skinship-1ff4b.appspot.com",
      messagingSenderId: "963752770497",
      appId: "1:963752770497:web:8911cc6a375acdbdcc8d40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let sessionMonitor = null;
    
    window.appState = {
      userRole: null,
      currentUserId: null,
      currentUserFullName: "",
      currentUserEmail: ""
    };

    let customersListener = null;
    let cashierListener = null;
    let inventoryListener = null;
    let staffListener = null;
    let purchaseOrderListener = null;

    // Session monitoring function
function setupSessionMonitoring(userId) {
  if (sessionMonitor) sessionMonitor(); // Cleanup previous listener
  
  const userRef = doc(db, "users", userId);
  const storedSessionId = sessionStorage.getItem('sessionId');
  
  if (!storedSessionId) {
    console.warn('No session ID found, logging out...');
    signOut(auth);
    return;
  }
  
  sessionMonitor = onSnapshot(userRef, (snapshot) => {
    if (!snapshot.exists()) {
      console.warn('User document no longer exists');
      signOut(auth);
      return;
    }
    
    const data = snapshot.data();
    const currentSessionId = data.currentSessionId;
    
    // Check if session ID has changed (another login or password change)
    if (currentSessionId && currentSessionId !== storedSessionId) {
      console.log('Session invalidated - another login detected or password changed');
      
      // Show notification before logout
showToast('Your session has been ended because someone else logged in or your password was changed', 'warning', 5000);
      
      // Force logout
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      });
    }
  }, (error) => {
    console.error('Session monitoring error:', error);
  });
}

    const dataCache = {
      customers: [],
      cashierReceipts: [],
      inventory: [],
      staff: []
    };

    // Toast notification system
function showToast(message, type = 'info', duration = 3000) {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  
  const icons = {
    success: 'fa-circle-check',
    error: 'fa-circle-xmark',
    warning: 'fa-triangle-exclamation',
    info: 'fa-circle-info'
  };
  
  const titles = {
    success: 'Success',
    error: 'Error',
    warning: 'Warning',
    info: 'Info'
  };
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fas ${icons[type]} toast-icon"></i>
    <div class="toast-content">
      <div class="toast-title">${titles[type]}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.closest('.toast').remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

window.showToast = showToast;

function monitorInventory() {
      if (inventoryListener) inventoryListener();

      const inventoryRef = collection(db, 'inventory');
      const inventoryQuery = query(inventoryRef, limit(100));
      
      inventoryListener = onSnapshot(inventoryQuery, (snapshot) => {
        let noStockCount = 0;
        let lowStockCount = 0;
        let overstockCount = 0;
        
        dataCache.inventory = [];
        
        snapshot.forEach(doc => {
          const item = doc.data();
          const status = item.status || '';
          
          // Use the status field directly (it's calculated when inventory is updated)
          if (status === 'out-of-stock') {
            noStockCount++;
          } else if (status === 'low-stock') {
            lowStockCount++;
          } else if (status === 'overstock') {
            overstockCount++;
          }
          
          dataCache.inventory.push({ id: doc.id, ...item });
        });
        
        updateInventoryBubble(noStockCount, lowStockCount, overstockCount);
        updateInventoryAlerts();
        
      }, (error) => {
        console.error('Error monitoring inventory:', error);
      });
    }

    function updateInventoryBubble(noStock, lowStock, overstock) {
      const button = document.querySelector('button[title="Inventory"]');
      if (!button) return;
      
      let bubble = button.querySelector('.sidebar-bubble');
      
      if (!bubble) {
        bubble = document.createElement('span');
        bubble.className = 'sidebar-bubble';
        button.appendChild(bubble);
      }
      
      if (noStock > 0) {
        bubble.textContent = noStock > 99 ? '99+' : noStock;
        bubble.style.backgroundColor = '#dc2626';
        bubble.style.display = 'flex';
      } else if (lowStock > 0) {
        bubble.textContent = lowStock > 99 ? '99+' : lowStock;
        bubble.style.backgroundColor = '#f59e0b';
        bubble.style.display = 'flex';
      } else if (overstock > 0) {
        bubble.textContent = overstock > 99 ? '99+' : overstock;
        bubble.style.backgroundColor = '#3b82f6';
        bubble.style.display = 'flex';
      } else {
        bubble.style.display = 'none';
      }
    }

    function monitorPurchaseOrders() {
      if (purchaseOrderListener) purchaseOrderListener();

      purchaseOrderListener = onSnapshot(
        query(collection(db, 'purchaseOrders'), where('status', '==', 'pending')),
        (snapshot) => {
          updatePurchaseOrderBubble(snapshot.size);
        },
        (error) => console.error('Error monitoring purchase orders:', error)
      );
    }

    function updatePurchaseOrderBubble(count) {
      const button = document.querySelector('button[title="Purchase Order"]');
      if (!button) return;
      
      let bubble = button.querySelector('.sidebar-bubble');
      
      if (!bubble) {
        bubble = document.createElement('span');
        bubble.className = 'sidebar-bubble';
        button.appendChild(bubble);
      }
      
      if (count > 0) {
        bubble.textContent = count > 99 ? '99+' : count;
        bubble.style.backgroundColor = '#8b5cf6';
        bubble.style.display = 'flex';
      } else {
        bubble.style.display = 'none';
      }
    }

async function handleClockOut() {
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    const today = new Date().toLocaleDateString();
    const logsRef = collection(db, "staffLogs", user.uid, "history");
    const todayQuery = query(logsRef, where("date", "==", today));
    const todaySnap = await getDocs(todayQuery);
    
    if (!todaySnap.empty) {
      const activeLog = todaySnap.docs.find(doc => !doc.data().clockOut);
      if (activeLog) {
        await setDoc(doc(db, "staffLogs", user.uid, "history", activeLog.id), {
          clockOut: new Date().toLocaleString()
        }, { merge: true });
      }
    }

    await updateDoc(doc(db, "users", user.uid), { 
      availability: false,
      onLaunchBreak: false,
      lastUpdated: serverTimestamp()
    });
  } catch (error) {
    console.error("Error during clock out:", error);
  }
}

    window.showLogoutModal = function() {
      document.getElementById('logoutModal').classList.add('show');
    }

    window.hideLogoutModal = function() {
      document.getElementById('logoutModal').classList.remove('show');
    }

window.confirmLogout = async function() {
  const confirmBtn = document.getElementById('confirmLogoutBtn');
  confirmBtn.classList.add('loading');
  confirmBtn.innerHTML = '<i class="fa-solid fa-spinner"></i> Logging out...';

  try {
    await handleClockOut();
    
    // Additional cleanup - set availability to false
    const user = auth.currentUser;
    if (user) {
      const userRef = doc(db, "users", user.uid);
      await updateDoc(userRef, { 
        availability: false,
        onLaunchBreak: false,
        lastUpdated: serverTimestamp()
      });
      
      // Wait for Firestore to update
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    if (customersListener) customersListener();
    if (cashierListener) cashierListener();
    if (inventoryListener) inventoryListener();
    if (staffListener) staffListener();
    if (purchaseOrderListener) purchaseOrderListener();
    if (sessionMonitor) sessionMonitor();

    sessionStorage.removeItem('sessionId');

    await signOut(auth);
    window.location.href = "index.html";
  } catch (error) {
    console.error("Logout error:", error);
    confirmBtn.classList.remove('loading');
    confirmBtn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Logout';
showToast("An error occurred during logout. Please try again.", 'error');
    await signOut(auth);
    window.location.href = "index.html";
  }
}

    document.getElementById('logoutModal')?.addEventListener('click', function(e) {
      if (e.target === this) window.hideLogoutModal();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('logoutModal');
        if (modal && modal.classList.contains('show')) window.hideLogoutModal();
      }
    });

    function loadDashboardData() {
      if (customersListener) customersListener();
      customersListener = onSnapshot(
        query(collection(db, "appointments"), orderBy("createdAt", "desc"), limit(100)),
        (snapshot) => {
          dataCache.customers = [];
          snapshot.forEach(doc => {
            dataCache.customers.push({ id: doc.id, ...doc.data() });
          });
          updateReservations();
          updateCounts();
          updateAgenda();
        }
      );

      if (cashierListener) cashierListener();
      cashierListener = onSnapshot(
        query(collection(db, "cashier_receipt"), orderBy("timestamp", "desc"), limit(200)),
        (snapshot) => {
          dataCache.cashierReceipts = [];
          snapshot.forEach(doc => {
            dataCache.cashierReceipts.push({ id: doc.id, ...doc.data() });
          });
          updateRevenueData();
        }
      );

      if (staffListener) staffListener();
      staffListener = onSnapshot(
        query(collection(db, "users"), limit(50)),
        (snapshot) => {
          dataCache.staff = [];
          snapshot.forEach(doc => {
            dataCache.staff.push({ id: doc.id, ...doc.data() });
          });
          updateStaffAvailability();
        }
      );
    }

function updateReservations() {
  const reservationTable = document.getElementById("reservationTable");
  reservationTable.innerHTML = "";
  
  if (dataCache.customers.length === 0) {
    reservationTable.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 italic">No reservations found</td></tr>';
    return;
  }

  let count = 0;
  dataCache.customers.forEach(data => {
    if (count >= 5) return;
    
    // Handle multiple services display
    let serviceDisplay = 'N/A';
    
    if (Array.isArray(data.services) && data.services.length > 0) {
      // Extract service names
      const serviceNames = data.services.map(s => {
        if (typeof s === 'object' && s.name) {
          return s.name;
        }
        return s.toString();
      });
      
      if (serviceNames.length === 1) {
        serviceDisplay = serviceNames[0];
      } else if (serviceNames.length === 2) {
        serviceDisplay = serviceNames.join(', ');
      } else {
        // Show first 2 services and add "+X more" indicator
        serviceDisplay = `${serviceNames[0]}, ${serviceNames[1]} +${serviceNames.length - 2}`;
      }
    } else if (data.service) {
      // Fallback to old single service format
      serviceDisplay = data.service;
    }
    
    const tr = document.createElement("tr");
    tr.className = "border-b";
    tr.innerHTML = `
      <td>${data.name || data.customer || "N/A"}</td>
      <td>${data.appointment || data.time || "N/A"}</td>
      <td>${(data.status || "Pending").charAt(0).toUpperCase() + (data.status || "Pending").slice(1)}</td>
      <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${serviceDisplay}">${serviceDisplay}</td>
      <td>${data.staff || "N/A"}</td>
    `;
    reservationTable.appendChild(tr);
    count++;
  });
}

    function updateCounts() {
      let completed = 0, pending = 0, cancelled = 0;

      dataCache.customers.forEach(data => {
        const status = (data.status || '').toLowerCase();
        if (status === 'completed') completed++;
        else if (status === 'pending') pending++;
        else if (status === 'cancelled' || status === 'canceled') cancelled++;
      });

      document.getElementById("completedCount").textContent = completed.toString().padStart(2, "0");
      document.getElementById("pendingCount").textContent = pending.toString().padStart(2, "0");
      document.getElementById("cancelledCount").textContent = cancelled.toString().padStart(2, "0");
    }

function updateAgenda() {
  const agendaList = document.getElementById("agendaList");
const today = new Date();
const todayISO = today.getFullYear() + '-' + 
                 String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(today.getDate()).padStart(2, '0');
console.log("Today's date:", todayISO);
console.log("Sample appointment date:", dataCache.customers[0]?.date);
  
  
  const todaysAppointments = dataCache.customers.filter(data => 
  data.appointmentDate === todayISO && (data.status || '').toLowerCase() === 'pending'
  ).sort((a, b) => (a.time || '').localeCompare(b.time || ''));

  agendaList.innerHTML = "";
  if (todaysAppointments.length === 0) {
    agendaList.innerHTML = '<li class="text-gray-500 italic">No appointments today</li>';
  } else {
    todaysAppointments.forEach(a => {
      // Handle multiple services display
      let serviceDisplay = '-';
      
      if (Array.isArray(a.services) && a.services.length > 0) {
        const serviceNames = a.services.map(s => {
          if (typeof s === 'object' && s.name) return s.name;
          return s.toString();
        });
        
        if (serviceNames.length === 1) {
          serviceDisplay = serviceNames[0];
        } else if (serviceNames.length === 2) {
          serviceDisplay = serviceNames.join(', ');
        } else {
          serviceDisplay = `${serviceNames[0]}, ${serviceNames[1]} +${serviceNames.length - 2}`;
        }
      } else if (a.service) {
        serviceDisplay = a.service;
      }
      
      const li = document.createElement('li');
      li.textContent = `${a.time || '-'} - ${a.name || a.customer || 'Customer'} - ${serviceDisplay}`;
      li.title = serviceDisplay; // Show full list on hover
      agendaList.appendChild(li);
    });
  }
}

    let currentInventoryIndex = 0;
    let inventoryItems = [];
    let inventoryInterval = null;

function createInventoryCarousel() {
  const inventoryAlerts = document.getElementById("inventoryAlerts");
  const inventoryNav = document.getElementById("inventoryNav");
  inventoryAlerts.innerHTML = "";
  inventoryNav.innerHTML = "";
  
  if (inventoryItems.length === 0) {
    inventoryAlerts.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 italic"><i class="fa-solid fa-box-open text-3xl mb-2 opacity-50"></i><p>No inventory alerts</p></div>';
    inventoryAlerts.style.height = '140px';
    if (inventoryInterval) clearInterval(inventoryInterval);
    return;
  }

  inventoryAlerts.style.position = 'relative';
  inventoryAlerts.style.height = '140px';
  inventoryAlerts.style.overflow = 'hidden';

  inventoryItems.forEach((item, index) => {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'inventory-alert-item';
    alertDiv.style.position = 'absolute';
    alertDiv.style.top = '0';
    alertDiv.style.left = '0';
    alertDiv.style.width = '100%';
    alertDiv.style.opacity = index === currentInventoryIndex ? '1' : '0';
    alertDiv.style.transition = 'opacity 0.5s ease';
    alertDiv.style.padding = '1rem';
    alertDiv.style.borderRadius = '0.75rem';
    alertDiv.style.border = `2px solid ${item.borderColor}`;
    alertDiv.style.background = item.bgColor;
    
    // Calculate percentage for progress bar
    let percentage = 0;
    if (item.statusText === "OVERSTOCK") {
      percentage = Math.min((item.quantity / item.minStock) * 100, 200);
    } else {
      percentage = Math.min((item.quantity / item.minStock) * 100, 100);
    }
    
    // Icon mapping
    let icon = 'fa-circle-exclamation';
    if (item.statusText === "OUT OF STOCK") icon = 'fa-triangle-exclamation';
    if (item.statusText === "OVERSTOCK") icon = 'fa-boxes-stacked';
    
    alertDiv.innerHTML = `
      <div class="flex items-start gap-3">
        <div style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${item.statusText === "OUT OF STOCK" ? '#dc2626' : item.statusText === "LOW STOCK" ? '#f59e0b' : '#3b82f6'}; color: white; flex-shrink: 0;">
          <i class="fa-solid ${icon}"></i>
        </div>
        <div style="flex: 1; min-width: 0;">
          <div class="flex justify-between items-start mb-2">
            <div style="flex: 1; min-width: 0;">
              <div class="font-semibold text-sm text-gray-800" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.productName}</div>
              <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-top: 0.25rem; background: ${item.statusText === "OUT OF STOCK" ? '#dc2626' : item.statusText === "LOW STOCK" ? '#f59e0b' : '#3b82f6'}; color: white;">${item.statusText}</span>
            </div>
            <div class="text-right" style="margin-left: 0.5rem;">
              <div class="font-bold text-lg ${item.statusColor}">${item.quantity}</div>
              <div class="text-xs text-gray-600">/ ${item.minStock}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div style="flex: 1; background: rgba(255, 255, 255, 0.7); border-radius: 9999px; height: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);">
              <div style="height: 100%; border-radius: 9999px; transition: width 0.5s ease; width: ${percentage}%; background: ${item.statusText === "OUT OF STOCK" ? '#dc2626' : item.statusText === "LOW STOCK" ? '#f59e0b' : '#3b82f6'};"></div>
            </div>
            <span class="text-xs font-semibold text-gray-700">${Math.round(percentage)}%</span>
          </div>
        </div>
      </div>
    `;
    
    if (window.appState.userRole === 'admin') {
      alertDiv.style.cursor = 'pointer';
      alertDiv.onclick = () => window.location.href = 'inventory.html';
      alertDiv.onmouseover = () => {
        alertDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
        alertDiv.style.transform = 'translateY(-2px)';
      };
      alertDiv.onmouseout = () => {
        alertDiv.style.boxShadow = 'none';
        alertDiv.style.transform = 'translateY(0)';
      };
    }
    
    inventoryAlerts.appendChild(alertDiv);

    // Create navigation dot
    const dot = document.createElement('div');
    dot.style.width = index === currentInventoryIndex ? '24px' : '10px';
    dot.style.height = '10px';
    dot.style.borderRadius = index === currentInventoryIndex ? '5px' : '50%';
    dot.style.background = index === currentInventoryIndex ? '#da5c73' : '#d1d5db';
    dot.style.cursor = 'pointer';
    dot.style.transition = 'all 0.3s ease';
    dot.onclick = () => goToInventorySlide(index);
    dot.onmouseover = () => {
      if (index !== currentInventoryIndex) {
        dot.style.background = '#b97b8b';
        dot.style.transform = 'scale(1.2)';
      }
    };
    dot.onmouseout = () => {
      if (index !== currentInventoryIndex) {
        dot.style.background = '#d1d5db';
        dot.style.transform = 'scale(1)';
      }
    };
    inventoryNav.appendChild(dot);
  });

  if (inventoryItems.length > 1) {
    if (inventoryInterval) clearInterval(inventoryInterval);
    inventoryInterval = setInterval(() => {
      currentInventoryIndex = (currentInventoryIndex + 1) % inventoryItems.length;
      goToInventorySlide(currentInventoryIndex);
    }, 5000);
  }
}

function goToInventorySlide(index) {
  currentInventoryIndex = index;
  const alerts = document.querySelectorAll('.inventory-alert-item');
  const dots = document.querySelectorAll('#inventoryNav > div');
  
  alerts.forEach((alert, i) => {
    alert.style.opacity = i === index ? '1' : '0';
  });
  
  dots.forEach((dot, i) => {
    dot.style.width = i === index ? '24px' : '10px';
    dot.style.borderRadius = i === index ? '5px' : '50%';
    dot.style.background = i === index ? '#da5c73' : '#d1d5db';
  });
  
  if (inventoryInterval) {
    clearInterval(inventoryInterval);
    if (inventoryItems.length > 1) {
      inventoryInterval = setInterval(() => {
        currentInventoryIndex = (currentInventoryIndex + 1) % inventoryItems.length;
        goToInventorySlide(currentInventoryIndex);
      }, 5000);
    }
  }
}
    window.goToInventorySlide = goToInventorySlide;

function updateInventoryAlerts() {
  const alertItems = [];
  dataCache.inventory.forEach(data => {
    const productName = data.name || "Unnamed Product";
    const quantity = Number(data.quantity || data.qty || 0);
    const minStock = Number(data.minStock || 10);
    const status = data.status || ''; // Read status directly from Firebase
    
    // ONLY show alerts for out-of-stock, low-stock, and overstock
    // Skip in-stock items
    if (status === 'out-of-stock') {
      alertItems.push({ 
        productName, 
        quantity, 
        minStock, 
        statusText: "OUT OF STOCK", 
        statusColor: "text-red-600",
        bgColor: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
        borderColor: '#fca5a5',
        priority: 1
      });
    }
    else if (status === 'low-stock') {
      alertItems.push({ 
        productName, 
        quantity, 
        minStock, 
        statusText: "LOW STOCK", 
        statusColor: "text-yellow-600",
        bgColor: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
        borderColor: '#fcd34d',
        priority: 2
      });
    }
    else if (status === 'overstock') {
      alertItems.push({ 
        productName, 
        quantity, 
        minStock, 
        statusText: "OVERSTOCK", 
        statusColor: "text-blue-600",
        bgColor: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
        borderColor: '#93c5fd',
        priority: 3
      });
    }
    // If status is 'in-stock' or anything else, we skip it (no alert needed)
  });

  // Sort by priority (out of stock first, then low stock, then overstock)
  alertItems.sort((a, b) => {
    if (a.priority !== b.priority) return a.priority - b.priority;
    return a.quantity - b.quantity;
  });
  
  inventoryItems = alertItems;
  currentInventoryIndex = 0;
  createInventoryCarousel();
}

    let revenueChart = null;

    function updateRevenueData() {
      const totalsByDay = {"Monday": 0, "Tuesday": 0, "Wednesday": 0, "Thursday": 0, "Friday": 0, "Saturday": 0, "Sunday": 0};
      let grandTotal = 0;

      dataCache.cashierReceipts.forEach(data => {
        const cost = Number(data.subtotal || data.amount || data.price || data.total_cost || 0);
        
        let day = null;
        if (data.day) {
          day = data.day;
        } else if (data.timestamp && typeof data.timestamp.toDate === "function") {
          day = data.timestamp.toDate().toLocaleDateString("en-US", { weekday: "long" });
        } else if (data.createdAt) {
          try {
            if (typeof data.createdAt === "string") {
              const d = new Date(data.createdAt);
              if (!isNaN(d)) day = d.toLocaleDateString("en-US", { weekday: "long" });
            } else if (typeof data.createdAt.toDate === "function") {
              day = data.createdAt.toDate().toLocaleDateString("en-US", { weekday: "long" });
            }
          } catch (e) {}
        }
        
        if (day && totalsByDay[day] !== undefined) totalsByDay[day] += cost;
        grandTotal += cost;
      });

      document.getElementById("revenueTotal").textContent = `Total of: ₱${grandTotal.toLocaleString("en-PH", {minimumFractionDigits: 2})}`;
      const daysOrder = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const revenueData = daysOrder.map(d => totalsByDay[d] || 0);

      if (revenueChart) {
        revenueChart.data.datasets[0].data = revenueData;
        revenueChart.update();
      } else {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: daysOrder,
            datasets: [{label: 'Revenue', data: revenueData, backgroundColor: '#f5a3b5', borderColor: '#da5c73', borderWidth: 1}]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {display: false}},
            scales: {y: {beginAtZero: true, ticks: {callback: function(value) {return '₱' + value.toLocaleString();}}}}
          }
        });
      }

      updateTopServices();
    }

    let topServicesChart = null;

    function updateTopServices() {
      const serviceCounts = {};
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      dataCache.cashierReceipts.forEach(data => {
        let docDate = null;
        if (data.timestamp && typeof data.timestamp.toDate === "function") {
          docDate = data.timestamp.toDate();
        } else if (data.createdAt) {
          try {
            if (typeof data.createdAt === "string") {
              docDate = new Date(data.createdAt);
            } else if (typeof data.createdAt.toDate === "function") {
              docDate = data.createdAt.toDate();
            }
          } catch (e) {}
        }

        if (!docDate || docDate >= sevenDaysAgo) {
          const items = data.items || [];
          items.forEach(item => {
            const name = item.name || "Unknown Service";
            serviceCounts[name] = (serviceCounts[name] || 0) + 1;
          });
        }
      });

      const sorted = Object.entries(serviceCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
      const labels = sorted.map(s => s[0]);
      const counts = sorted.map(s => s[1]);
      const colors = ['#5b9bd5', '#70ad47', '#ffc000'];

      if (topServicesChart) {
        topServicesChart.data.labels = labels;
        topServicesChart.data.datasets[0].data = counts;
        topServicesChart.data.datasets[0].backgroundColor = colors.slice(0, counts.length);
        topServicesChart.update();
      } else {
        const ctx = document.getElementById('topServicesChart').getContext('2d');
        topServicesChart = new Chart(ctx, {
          type: 'bar',
          data: {labels: labels, datasets: [{label: 'Services Sold', data: counts, backgroundColor: colors, borderWidth: 0}]},
          options: {indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: {legend: {display: false}}, scales: {x: {beginAtZero: true, ticks: {stepSize: 1, precision: 0}}}}
        });
      }
    }

function updateStaffAvailability() {
  const staffAvailabilityList = document.getElementById("staffAvailabilityList");
  staffAvailabilityList.innerHTML = '';

  const onlineUsers = [];
  const absentUsers = [];
  let currentUserInfo = null;

  dataCache.staff.forEach(userData => {
    const userId = userData.id;
    const name = userData.fullName || userData.username || "Unnamed";
    const isAvailable = userData.availability === true;
    const isAbsent = userData.isAbsent === true;
    const onLaunchBreak = userData.onLaunchBreak === true;

    if (userId === window.appState.currentUserId) {
      currentUserInfo = { name, isAvailable, isAbsent, onLaunchBreak };
    }
    
    // Add to absent list if marked absent
    if (isAbsent) {
      absentUsers.push({ id: userId, name, isCurrentUser: userId === window.appState.currentUserId });
    }
    // Don't show in online list if absent, unavailable, on break, or current user
    else if (!isAvailable || onLaunchBreak || userId === window.appState.currentUserId) {
      return;
    } else {
      onlineUsers.push({ id: userId, name });
    }
  });

  // Show current user first if available and not absent
  if (currentUserInfo && currentUserInfo.isAvailable && !currentUserInfo.isAbsent && !currentUserInfo.onLaunchBreak) {
    const div = document.createElement("div");
    div.className = "staff-availability-item";
    div.style.fontWeight = "600";
    div.style.background = "#d1fae5";
    div.innerHTML = `<div class="status-dot"></div><span>${currentUserInfo.name} (You)</span>`;
    staffAvailabilityList.appendChild(div);
  }

  // Show current user if on break
  if (currentUserInfo && currentUserInfo.onLaunchBreak && !currentUserInfo.isAbsent) {
    const div = document.createElement("div");
    div.className = "staff-availability-item";
    div.style.fontWeight = "600";
    div.style.background = "#fef3c7";
    div.innerHTML = `
      <div class="status-dot" style="background: #f59e0b;"></div>
      <span>${currentUserInfo.name} (You) - On Break</span>
    `;
    staffAvailabilityList.appendChild(div);
  }

  // Show current user if absent
  if (currentUserInfo && currentUserInfo.isAbsent) {
    const div = document.createElement("div");
    div.className = "staff-availability-item";
    div.style.fontWeight = "600";
    div.style.background = "#fee2e2";
    div.innerHTML = `
      <div class="status-dot" style="background: #dc2626;"></div>
      <span>${currentUserInfo.name} (You) - Absent</span>
    `;
    staffAvailabilityList.appendChild(div);
  }

  // Show other online users
  if (onlineUsers.length > 0) {
    onlineUsers.forEach(user => {
      const div = document.createElement("div");
      div.className = "staff-availability-item";
      div.innerHTML = `<div class="status-dot"></div><span>${user.name}</span>`;
      staffAvailabilityList.appendChild(div);
    });
  }

  // Show absent users
  if (absentUsers.length > 0) {
    absentUsers.forEach(user => {
      // Skip if already shown as current user
      if (user.isCurrentUser) return;
      
      const div = document.createElement("div");
      div.className = "staff-availability-item";
      div.style.background = "#fee2e2";
      div.innerHTML = `
        <div class="status-dot" style="background: #dc2626;"></div>
        <span>${user.name} - Absent</span>
      `;
      staffAvailabilityList.appendChild(div);
    });
  }

  // Show "No users online" only if no one is available (excluding absent users)
  if (onlineUsers.length === 0 && (!currentUserInfo || !currentUserInfo.isAvailable || currentUserInfo.isAbsent || currentUserInfo.onLaunchBreak)) {
    if (absentUsers.length === 0) {
      staffAvailabilityList.innerHTML = '<p class="text-gray-500 italic text-sm">No users online</p>';
    }
  }
}

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        window.appState.currentUserId = user.uid;
        window.appState.currentUserEmail = user.email;
        
        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);

          await updateDoc(userRef, { 
              availability: true,
              lastUpdated: serverTimestamp()
            });

            // ADD THIS - Start session monitoring
            setupSessionMonitoring(user.uid);

            loadDashboardData();

          if (userSnap.exists()) {
            const data = userSnap.data();
            const userRole = data.role || "staff";
            window.appState.userRole = userRole;
            window.appState.currentUserFullName = data.username || data.fullName || user.email || "User";
            
            document.getElementById("usernameDisplay").textContent = window.appState.currentUserFullName;
            document.getElementById("logoutUsername").textContent = window.appState.currentUserFullName;
            
            if (userRole === "admin") {
              document.documentElement.classList.add('admin-loaded');
              document.documentElement.classList.remove('staff-loaded');
            } else {
              document.documentElement.classList.add('staff-loaded');
              document.documentElement.classList.remove('admin-loaded');
            }

            const today = new Date().toLocaleDateString();
            const logsRef = collection(db, "staffLogs", user.uid, "history");
            const todayQuery = query(logsRef, where("date", "==", today));
            const todaySnap = await getDocs(todayQuery);
            
            let needsNewLog = true;
            if (!todaySnap.empty) {
              const activeSession = todaySnap.docs.find(doc => !doc.data().clockOut);
              if (activeSession) needsNewLog = false;
            }
            
            if (needsNewLog) {
              await addDoc(logsRef, {
                date: today,
                clockIn: new Date().toLocaleString(),
                clockOut: null,
                timestamp: serverTimestamp()
              });
            }

            await updateDoc(userRef, { 
              availability: true,
              lastUpdated: serverTimestamp()
            });

            loadDashboardData();
            monitorInventory();
            monitorPurchaseOrders();
          }
        } catch (err) {
          console.error("Error fetching user document:", err);
          document.documentElement.classList.add('staff-loaded');
          document.documentElement.classList.remove('admin-loaded');
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    document.getElementById('logoutBtn')?.addEventListener('click', () => window.showLogoutModal());
    window.addEventListener("beforeunload", async () => await handleClockOut());
    
    window.toggleUserMenu = function(event) {
      event.stopPropagation();
      document.getElementById('userMenu').classList.toggle('hidden');
    }
    
    window.addEventListener('click', (e) => {
      const userMenu = document.getElementById('userMenu');
      const btn = document.getElementById('userMenuButton');
      if (btn && !btn.contains(e.target) && userMenu && !userMenu.contains(e.target)) {
        userMenu.classList.add('hidden');
      }
    });
  </script>

  <script>
    class MagicBentoEffect {
      constructor(gridSelector) {
        this.grid = document.querySelector(gridSelector);
        if (!this.grid) return;
        
        this.cards = this.grid.querySelectorAll('.magic-card');
        this.spotlight = null;
        this.particleCount = 10;
        this.isMobile = window.innerWidth <= 768;
        this.particlesCache = new WeakMap();
        
        if (!this.isMobile) this.init();
      }

      init() {
        this.createSpotlight();
        this.cards.forEach(card => this.initCard(card));
        document.addEventListener('mousemove', this.handleMouseMove.bind(this));
      }

      createSpotlight() {
        this.spotlight = document.createElement('div');
        this.spotlight.className = 'global-spotlight';
        document.body.appendChild(this.spotlight);
      }

      initCard(card) {
        const particles = [];
        let isHovering = false;
        
        if (!this.particlesCache.has(card)) {
          const cached = [];
          for (let i = 0; i < this.particleCount; i++) {
            const el = document.createElement('div');
            el.className = 'particle';
            el.style.left = `${Math.random() * card.offsetWidth}px`;
            el.style.top = `${Math.random() * card.offsetHeight}px`;
            cached.push(el);
          }
          this.particlesCache.set(card, cached);
        }
        
        card.addEventListener('mouseenter', () => {
          isHovering = true;
          const cached = this.particlesCache.get(card);
          cached.forEach((template, i) => {
            setTimeout(() => {
              if (!isHovering) return;
              
              const particle = template.cloneNode(true);
              card.appendChild(particle);
              particles.push(particle);
              
              gsap.fromTo(particle, { scale: 0, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3, ease: 'back.out(1.7)' });
              gsap.to(particle, { x: (Math.random() - 0.5) * 100, y: (Math.random() - 0.5) * 100, rotation: Math.random() * 360, duration: 2 + Math.random() * 2, ease: 'none', repeat: -1, yoyo: true });
              gsap.to(particle, { opacity: 0.4, duration: 1.2, ease: 'power2.inOut', repeat: -1, yoyo: true });
            }, i * 100);
          });

          gsap.to(card, { rotateX: 5, rotateY: 5, duration: 0.3, ease: 'power2.out', transformPerspective: 1000 });
        });

        card.addEventListener('mouseleave', () => {
          isHovering = false;
          particles.forEach(p => gsap.to(p, { scale: 0, opacity: 0, duration: 0.3, onComplete: () => p.remove() }));
          particles.length = 0;
          gsap.to(card, { rotateX: 0, rotateY: 0, duration: 0.3, ease: 'power2.out' });
        });

        card.addEventListener('mousemove', (e) => {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          gsap.to(card, { rotateX: ((y - centerY) / centerY) * -10, rotateY: ((x - centerX) / centerX) * 10, duration: 0.1, ease: 'power2.out', transformPerspective: 1000 });

          card.style.setProperty('--glow-x', `${(x / rect.width) * 100}%`);
          card.style.setProperty('--glow-y', `${(y / rect.height) * 100}%`);
          card.style.setProperty('--glow-intensity', '1');
        });
      }

      handleMouseMove(e) {
        const section = this.grid.closest('.bento-section');
        const rect = section?.getBoundingClientRect() || this.grid.getBoundingClientRect();
        const mouseInGrid = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;

        if (!mouseInGrid) {
          gsap.to(this.spotlight, { opacity: 0, duration: 0.3 });
          this.cards.forEach(card => card.style.setProperty('--glow-intensity', '0'));
          return;
        }

        gsap.to(this.spotlight, { left: e.clientX, top: e.clientY, duration: 0.1, ease: 'power2.out' });

        let minDistance = Infinity;
        this.cards.forEach(card => {
          const cardRect = card.getBoundingClientRect();
          const centerX = cardRect.left + cardRect.width / 2;
          const centerY = cardRect.top + cardRect.height / 2;
          const distance = Math.hypot(e.clientX - centerX, e.clientY - centerY) - Math.max(cardRect.width, cardRect.height) / 2;
          const effectiveDistance = Math.max(0, distance);
          minDistance = Math.min(minDistance, effectiveDistance);

          const proximity = 225;
          const fadeDistance = 337.5;
          let glowIntensity = 0;
          if (effectiveDistance <= proximity) glowIntensity = 1;
          else if (effectiveDistance <= fadeDistance) glowIntensity = (fadeDistance - effectiveDistance) / (fadeDistance - proximity);

          card.style.setProperty('--glow-x', `${((e.clientX - cardRect.left) / cardRect.width) * 100}%`);
          card.style.setProperty('--glow-y', `${((e.clientY - cardRect.top) / cardRect.height) * 100}%`);
          card.style.setProperty('--glow-intensity', glowIntensity.toString());
        });

        const targetOpacity = minDistance <= 225 ? 1.2 : minDistance <= 337.5 ? ((337.5 - minDistance) / 112.5) * 1.2 : 0;
        gsap.to(this.spotlight, { opacity: targetOpacity, duration: targetOpacity > 0 ? 0.2 : 0.5, ease: 'power2.out' });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (window.innerWidth > 768) new MagicBentoEffect('#dashboardGrid');
      });
    } else {
      if (window.innerWidth > 768) new MagicBentoEffect('#dashboardGrid');
    }

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth > 768) {
          const oldSpotlight = document.querySelector('.global-spotlight');
          if (oldSpotlight) oldSpotlight.remove();
          new MagicBentoEffect('#dashboardGrid');
        }
      }, 250);
    });
  </script>

</body>
</html>